---
title: "Poster Figure set 11_17"
output: html_document
---

```{r global_options, include=FALSE}
#global settings
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, error=FALSE)
```

```{r}
#Packages
library(tidyverse)
library(lubridate)
library(ggridges)
```

```{r}
dogg <- read.csv("Tempsanddata_11_8.csv")
comb <- read.csv("Talltemps_11_17.csv")
```

Making my custom theme with transparent backgrounds
```{r}
theme_invis <- function (){
        theme(text= element_text(size=17),
        panel.background  = element_blank(),
        plot.background = element_rect(fill="transparent", colour=NA),
        legend.background = element_rect(fill="transparent", colour=NA),
        legend.key = element_rect(fill="transparent", colour=NA),
        panel.border = element_blank(), panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.line = element_line(colour = "black", 
                size = rel(1)))
}

theme_in <- function(){
theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.line = element_line(colour = "black", 
                size = rel(1)), legend.key = element_blank(), 
            strip.background = element_rect(fill = "transparent", 
                colour = "black", size = rel(2)), complete = TRUE)
}
      
      
      
      
      panel.border = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
         panel.background = element_rect(fill = "transparent", color = NA), # bg of the panel
         plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
         legend.background = element_rect(fill = "transparent", color = NA), # get rid of legend bg
         legend.box.background = element_rect(fill = "transparent", color = NA),
         legend.margin = element_blank(),
         legend.key = element_rect(fill = "transparent", color = NA))
}
```


11/17
Making final plots for AGU poster
```{r}
#Boxplot of distribution of temps
elevators <- ggplot(data = comb, 
                    aes(x = fct_reorder(site, Elevation..ft.),
                        y = Value,
                        fill = type))+
  theme_classic()+
  labs(x = "Elevation",
       y = "WaterT (C)")+
  guides(fill=FALSE)+
  theme(panel.border = element_rect(colour = "black"),
        rect = element_rect(fill = "transparent"),
         panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    strip.background = element_blank(),
    #axis.text.x = element_text(size = 17),
        axis.text.y = element_text(size = 17),
    axis.title.y=element_text(size = 17),
        axis.title.x=element_text(size = 17)
)+
  geom_boxplot()+
  facet_grid(rows = vars(type))
elevators
ggsave(elevators, filename = "elev_boxplots_11_17.png",  bg = "transparent",
       width = 7.5, height = 4.8, units = c("in"))

```

Air temp vs head and downstream sites
```{r}
#airT vs WaterT
heady <- ggplot(dogg, aes(x = airT,
                          y = head.temp,
                          color = shed))+
  geom_point(size = 1,
             alpha = 0.25)+
  #geom_smooth(method = 'lm', se = FALSE)+
  theme_invis()+
  scale_color_brewer(palette = "Spectral")+
  labs(x = "Average airT (C)",
       y = "Average WaterT (C)")

#downstream sites
downy <- ggplot(dogg, aes(x = airT,
                          y = Value,
                          color = shed))+
  geom_point(size = 1,
             alpha = 0.25)+
  #geom_smooth(method = 'lm', se = FALSE)+
  theme_invis()+
  scale_color_brewer(palette = "Spectral")+
  labs(x = "Average airT (C)",
       y = "Average WaterT (C)")

downy
heady

ggsave(downy, filename = "downvsair.png",  bg = "transparent")
ggsave(heady, filename = "headvsair.png",  bg = "transparent")

```
Model
```{r}
h.avg.model <- lm(head.dmean ~ 
                slope.mean  +
                elev.mean + 
                UAA..ft2.,data = dogg)
summary(h.avg.model)
modeltester <- dogg%>%
  select(Site, shed, slope.mean, elev.mean, AREA, UAA..ft2., head.temp)%>%
  mutate(h.avg.model = 1.261e-01 * slope.mean + 
  -6.722e-04 * elev.mean + 
   5.125e-06 * UAA..ft2.+
   8.329e+00)%>%
  group_by(Site)%>%
  mutate(avg.head = mean(head.temp, na.rm = TRUE))

moss <- read.csv("modelmaybemoses_11_21.csv")

plotJPwants <- ggplot()+
  theme_classic()+
  geom_point(data = modeltester, aes(x = avg.head,
                              y = h.avg.model,
                              color = shed), size = 3)+
   #geom_smooth(method = 'lm', se = FALSE)+
  labs(x = "Measured average head temp (C)",
       y = "Modeled average head temp")+
  theme_invis()
plotJPwants

ggsave(plotJPwants, filename = "avgheadmodel.png",  bg = "transparent",
       width = 7.5, height = 5, units = c("in"))

```

```{r}
#formatting time for timeseries
dogg$rnd.dates <- ymd_hms(dogg$rnd.dates)
#removing value from RMO that is crazy high
which(rogg$Value > 20)
# 28721 28722
rogg$Value[28722] <- NA
rogg$Value[28721] <- NA

```

Timeseries
```{r}
rogg <- dogg
rogg <- rogg %>% mutate_each(list(as.character), shed, Site)
rogg$shed <- factor(rogg$shed, levels = c("GG", "ULB", "RMO", "MUL"))
rogg$Site <- factor(rogg$Site, levels = c("Wind", "Glac", "Land",
            "ULB2", "ULB3", "ULB4",
            "RMO1", "RMO2", "RMO3",
            "MUL2", "MUL4", "MUL7"))

#making colors for the plots
breaks <- c("Wind", "Glac", "Land",
            "ULB2", "ULB3", "ULB4",
            "RMO1", "RMO2", "RMO3",
            "MUL2", "MUL4", "MUL7")
colors <- c("firebrick4", "firebrick3", "firebrick2",
            "slateblue4", "slateblue3", "slateblue2",
            "sienna4", "sienna3", "sienna2",
            "seagreen", "seagreen3", "seagreen1")

timepanel <- ggplot(rogg, aes(color = Site))+
  geom_line(aes(x = rnd.dates,
               y = Value))+
  geom_line(aes(x = rnd.dates,
                y = head.temp))+
  theme_classic()+
  theme(panel.border = element_rect(colour = "black"),
        rect = element_rect(fill = "transparent"),
         panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    strip.background = element_blank(),
    text= element_text(size=17))+
  facet_grid(cols = vars(shed), rows = vars(type))+
  scale_color_manual(breaks = breaks,
                    values = colors)
timepanel

ggsave(timepanel, filename = "timepanel.png",  bg = "transparent",
       width = 24, height = 5, units = c("in"))
```

Head temp vs Down Temps
```{r}
shed.breaks <- c("GG","ULB","RMO","MUL")
shed.colors <- c("firebrick4","slateblue4","sienna2","seagreen1")

#head temps vs down temps
down.heads <- ggplot(dogg, aes(x = head.temp,
                               y = Value))+
  #stat_density2d(size = 0.5)+
  scale_color_brewer(palette = "Dark2")+
  geom_point(aes(color = shed),
             size = 2, alpha = 0.5)+
  #geom_smooth(method = 'lm', se = FALSE, color = "black")+
  theme_invis()+
  scale_color_manual(breaks = shed.breaks,
                    values = shed.colors)+
  labs(x = "Head Temperature (C)",
       y = "Downstream Temperature (C)")
down.heads

ggsave(down.heads, filename = "headvsdown.png",  bg = "transparent",
       width = 7.5, height = 5, units = c("in"))
```

R2 through time- rolling multi regs
```{r}
#Baseline regressions- the control for this part of the poster
#using all of the sites
h.avg.model <- lm(head.dmean ~ 
                slope.mean  +
                elev.mean + 
                UAA..ft2.,data = dogg)
summary(h.avg.model)
hair.avg.model <- lm(head.dmean ~ 
                slope.mean  +
                elev.mean + 
                UAA..ft2. +
                air.d.mean  ,data = dogg)
summary(hair.avg.model)
#using just gg sites- elevation removed bc it made no contribution
grib.base <- lm(head.dmean ~ slope.mean + UAA..ft2.  + elev.mean, air.d.mean, data = grib)
summary(grib.base)

grib.base.noair <- lm(head.dmean ~ slope.mean + UAA..ft2. + elev.mean, data = grib)
summary(grib.base.noair)

```

Trying to add other two air temps to model to see if it improves
```{r}
#my custom function
rickroll7 <- function(x, na.rm = TRUE){
  roll <- x
  model <- lm(wind.ts$head.dmean ~  
                #roll$TOBS  +
                roll$TMAX +
                roll$TMIN +
                wind.ts$slope.mean + 
                wind.ts$UAA..ft2. + 
                wind.ts$elev.mean)
  r <- summary(model)$r.squared
  return(r)
}
#my attempt to do a rolling calculation
#success!
#last 5 years
gribregulation <- last5%>%
  tq_mutate(select = c(TMIN, TMAX),
                       #, TOBS),
            mutate_fun = rollapply,
            width = 26,
            align = "right",
            by.column = FALSE,
            FUN = rickroll)

test <- ggplot(gribregulation, aes(x = DATE,
                           y = value))+
  geom_line()+
  theme_classic()+
  labs(title = "Wind with TMIN and TMAX", y = "R^2")

test + geom_hline(yintercept = 0.7557, color = "red")+
  geom_hline(yintercept = 0.8973, color = "blue")
```

Wind
```{r}
#starting with running the others individually
w.ts <- filter(grib, Site == "Wind")
w.ts$rnd.dates <- date(w.ts$rnd.dates)
w.ts <- unique(w.ts)
#w.ts <- ls.ts[-26,]

#applying topo metrics to last 20 years of temp data
rickroll4 <- function(x, na.rm = TRUE){
  roll <- x
  model <- lm(w.ts$head.dmean ~  
                roll  + 
                w.ts$slope.mean + 
                w.ts$UAA..ft2. + 
                w.ts$elev.mean)
 
  r <- summary(model)$r.squared
  return(r)
}
#my attempt to do a rolling calculation
#success!
#last 5 years
w.reg <- last5%>%
  tq_mutate(select = TOBS,
            mutate_fun = rollapply,
            width = 26,
            align = "right",
            by.column = FALSE,
            FUN = rickroll4)
  
w.regplot <- ggplot(w.reg, aes(x = DATE,
                           y = value))+
  geom_line()+
  theme_classic()+
  labs(title = "Wind with TOBS", y = "R^2")


w.regplot + geom_hline(yintercept = 0.7557, color = "red")+
  geom_hline(yintercept = 0.8973, color = "blue")
```

